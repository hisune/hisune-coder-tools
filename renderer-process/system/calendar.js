/**
 * Created by Hisune on 2016/9/1.
 * User: hi@hisune.com
 */
'use strict';

const storage = require('electron-json-storage'),
    dialogs = new (require('dialogs')),
    calendarDom = $('#calendar'),
    calendarEventObj = $('#calendar-event'),
    today = new Date(),
    calendar = {lunarInfo:[19416,19168,42352,21717,53856,55632,91476,22176,39632,21970,19168,42422,42192,53840,119381,46400,54944,44450,38320,84343,18800,42160,46261,27216,27968,109396,11104,38256,21234,18800,25958,54432,59984,28309,23248,11104,100067,37600,116951,51536,54432,120998,46416,22176,107956,9680,37584,53938,43344,46423,27808,46416,86869,19872,42416,83315,21168,43432,59728,27296,44710,43856,19296,43748,42352,21088,62051,55632,23383,22176,38608,19925,19152,42192,54484,53840,54616,46400,46752,103846,38320,18864,43380,42160,45690,27216,27968,44870,43872,38256,19189,18800,25776,29859,59984,27480,21952,43872,38613,37600,51552,55636,54432,55888,30034,22176,43959,9680,37584,51893,43344,46240,47780,44368,21977,19360,42416,86390,21168,43312,31060,27296,44368,23378,19296,42726,42208,53856,60005,54576,23200,30371,38608,19195,19152,42192,118966,53840,54560,56645,46496,22224,21938,18864,42359,42160,43600,111189,27936,44448,84835,37744,18936,18800,25776,92326,59984,27424,108228,43744,41696,53987,51552,54615,54432,55888,23893,22176,42704,21972,21200,43448,43344,46240,46758,44368,21920,43940,42416,21168,45683,26928,29495,27296,44368,84821,19296,42352,21732,53600,59752,54560,55968,92838,22224,19168,43476,41680,53584,62034,54560],solarMonth:[31,28,31,30,31,30,31,31,30,31,30,31],Gan:["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"],Zhi:["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"],Animals:["鼠","牛","虎","兔","龙","蛇","马","羊","猴","鸡","狗","猪"],solarTerm:["小寒","大寒","立春","雨水","惊蛰","春分","清明","谷雨","立夏","小满","芒种","夏至","小暑","大暑","立秋","处暑","白露","秋分","寒露","霜降","立冬","小雪","大雪","冬至"],sTermInfo:["9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf97c3598082c95f8c965cc920f","97bd0b06bdb0722c965ce1cfcc920f","b027097bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf97c359801ec95f8c965cc920f","97bd0b06bdb0722c965ce1cfcc920f","b027097bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf97c359801ec95f8c965cc920f","97bd0b06bdb0722c965ce1cfcc920f","b027097bd097c36b0b6fc9274c91aa","9778397bd19801ec9210c965cc920e","97b6b97bd19801ec95f8c965cc920f","97bd09801d98082c95f8e1cfcc920f","97bd097bd097c36b0b6fc9210c8dc2","9778397bd197c36c9210c9274c91aa","97b6b97bd19801ec95f8c965cc920e","97bd09801d98082c95f8e1cfcc920f","97bd097bd097c36b0b6fc9210c8dc2","9778397bd097c36c9210c9274c91aa","97b6b97bd19801ec95f8c965cc920e","97bcf97c3598082c95f8e1cfcc920f","97bd097bd097c36b0b6fc9210c8dc2","9778397bd097c36c9210c9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf97c3598082c95f8c965cc920f","97bd097bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf97c3598082c95f8c965cc920f","97bd097bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf97c359801ec95f8c965cc920f","97bd097bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf97c359801ec95f8c965cc920f","97bd097bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf97c359801ec95f8c965cc920f","97bd097bd07f595b0b6fc920fb0722","9778397bd097c36b0b6fc9210c8dc2","9778397bd19801ec9210c9274c920e","97b6b97bd19801ec95f8c965cc920f","97bd07f5307f595b0b0bc920fb0722","7f0e397bd097c36b0b6fc9210c8dc2","9778397bd097c36c9210c9274c920e","97b6b97bd19801ec95f8c965cc920f","97bd07f5307f595b0b0bc920fb0722","7f0e397bd097c36b0b6fc9210c8dc2","9778397bd097c36c9210c9274c91aa","97b6b97bd19801ec9210c965cc920e","97bd07f1487f595b0b0bc920fb0722","7f0e397bd097c36b0b6fc9210c8dc2","9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf7f1487f595b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf7f1487f595b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf7f1487f531b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c965cc920e","97bcf7f1487f531b0b0bb0b6fb0722","7f0e397bd07f595b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b97bd19801ec9210c9274c920e","97bcf7f0e47f531b0b0bb0b6fb0722","7f0e397bd07f595b0b0bc920fb0722","9778397bd097c36b0b6fc9210c91aa","97b6b97bd197c36c9210c9274c920e","97bcf7f0e47f531b0b0bb0b6fb0722","7f0e397bd07f595b0b0bc920fb0722","9778397bd097c36b0b6fc9210c8dc2","9778397bd097c36c9210c9274c920e","97b6b7f0e47f531b0723b0b6fb0722","7f0e37f5307f595b0b0bc920fb0722","7f0e397bd097c36b0b6fc9210c8dc2","9778397bd097c36b0b70c9274c91aa","97b6b7f0e47f531b0723b0b6fb0721","7f0e37f1487f595b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc9210c8dc2","9778397bd097c36b0b6fc9274c91aa","97b6b7f0e47f531b0723b0b6fb0721","7f0e27f1487f595b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e397bd07f595b0b0bc920fb0722","9778397bd097c36b0b6fc9274c91aa","97b6b7f0e47f531b0723b0787b0721","7f0e27f0e47f531b0b0bb0b6fb0722","7f0e397bd07f595b0b0bc920fb0722","9778397bd097c36b0b6fc9210c91aa","97b6b7f0e47f149b0723b0787b0721","7f0e27f0e47f531b0723b0b6fb0722","7f0e397bd07f595b0b0bc920fb0722","9778397bd097c36b0b6fc9210c8dc2","977837f0e37f149b0723b0787b0721","7f07e7f0e47f531b0723b0b6fb0722","7f0e37f5307f595b0b0bc920fb0722","7f0e397bd097c35b0b6fc9210c8dc2","977837f0e37f14998082b0787b0721","7f07e7f0e47f531b0723b0b6fb0721","7f0e37f1487f595b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc9210c8dc2","977837f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc920fb0722","977837f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e397bd097c35b0b6fc920fb0722","977837f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e397bd07f595b0b0bc920fb0722","977837f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e397bd07f595b0b0bc920fb0722","977837f0e37f14998082b0787b06bd","7f07e7f0e47f149b0723b0787b0721","7f0e27f0e47f531b0b0bb0b6fb0722","7f0e397bd07f595b0b0bc920fb0722","977837f0e37f14998082b0723b06bd","7f07e7f0e37f149b0723b0787b0721","7f0e27f0e47f531b0723b0b6fb0722","7f0e397bd07f595b0b0bc920fb0722","977837f0e37f14898082b0723b02d5","7ec967f0e37f14998082b0787b0721","7f07e7f0e47f531b0723b0b6fb0722","7f0e37f1487f595b0b0bb0b6fb0722","7f0e37f0e37f14898082b0723b02d5","7ec967f0e37f14998082b0787b0721","7f07e7f0e47f531b0723b0b6fb0722","7f0e37f1487f531b0b0bb0b6fb0722","7f0e37f0e37f14898082b0723b02d5","7ec967f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e37f1487f531b0b0bb0b6fb0722","7f0e37f0e37f14898082b072297c35","7ec967f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e37f0e37f14898082b072297c35","7ec967f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e37f0e366aa89801eb072297c35","7ec967f0e37f14998082b0787b06bd","7f07e7f0e47f149b0723b0787b0721","7f0e27f1487f531b0b0bb0b6fb0722","7f0e37f0e366aa89801eb072297c35","7ec967f0e37f14998082b0723b06bd","7f07e7f0e47f149b0723b0787b0721","7f0e27f0e47f531b0723b0b6fb0722","7f0e37f0e366aa89801eb072297c35","7ec967f0e37f14998082b0723b06bd","7f07e7f0e37f14998083b0787b0721","7f0e27f0e47f531b0723b0b6fb0722","7f0e37f0e366aa89801eb072297c35","7ec967f0e37f14898082b0723b02d5","7f07e7f0e37f14998082b0787b0721","7f07e7f0e47f531b0723b0b6fb0722","7f0e36665b66aa89801e9808297c35","665f67f0e37f14898082b0723b02d5","7ec967f0e37f14998082b0787b0721","7f07e7f0e47f531b0723b0b6fb0722","7f0e36665b66a449801e9808297c35","665f67f0e37f14898082b0723b02d5","7ec967f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e36665b66a449801e9808297c35","665f67f0e37f14898082b072297c35","7ec967f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e26665b66a449801e9808297c35","665f67f0e37f1489801eb072297c35","7ec967f0e37f14998082b0787b06bd","7f07e7f0e47f531b0723b0b6fb0721","7f0e27f1487f531b0b0bb0b6fb0722"],nStr1:["日","一","二","三","四","五","六","七","八","九","十"],nStr2:["初","十","廿","卅"],nStr3:["正","二","三","四","五","六","七","八","九","十","冬","腊"],lYearDays:function(y){var i,sum=348;for(i=32768;i>8;i>>=1)sum+=calendar.lunarInfo[y-1900]&i?1:0;return sum+calendar.leapDays(y)},leapMonth:function(y){return 15&calendar.lunarInfo[y-1900]},leapDays:function(y){return calendar.leapMonth(y)?65536&calendar.lunarInfo[y-1900]?30:29:0},monthDays:function(y,m){return m>12||m<1?-1:calendar.lunarInfo[y-1900]&65536>>m?30:29},solarDays:function(y,m){if(m>12||m<1)return-1;var ms=m-1;return 1==ms?y%4==0&&y%100!=0||y%400==0?29:28:calendar.solarMonth[ms]},toGanZhiYear:function(lYear){var ganKey=(lYear-3)%10,zhiKey=(lYear-3)%12;return 0==ganKey&&(ganKey=10),0==zhiKey&&(zhiKey=12),calendar.Gan[ganKey-1]+calendar.Zhi[zhiKey-1]},toAstro:function(cMonth,cDay){var s="魔羯水瓶双鱼白羊金牛双子巨蟹狮子处女天秤天蝎射手魔羯",arr=[20,19,21,21,21,22,23,23,23,23,22,22];return s.substr(2*cMonth-(cDay<arr[cMonth-1]?2:0),2)+"座"},toGanZhi:function(offset){return calendar.Gan[offset%10]+calendar.Zhi[offset%12]},getTerm:function(y,n){if(y<1900||y>2100)return-1;if(n<1||n>24)return-1;var _table=calendar.sTermInfo[y-1900],_info=[parseInt("0x"+_table.substr(0,5)).toString(),parseInt("0x"+_table.substr(5,5)).toString(),parseInt("0x"+_table.substr(10,5)).toString(),parseInt("0x"+_table.substr(15,5)).toString(),parseInt("0x"+_table.substr(20,5)).toString(),parseInt("0x"+_table.substr(25,5)).toString()],_calday=[_info[0].substr(0,1),_info[0].substr(1,2),_info[0].substr(3,1),_info[0].substr(4,2),_info[1].substr(0,1),_info[1].substr(1,2),_info[1].substr(3,1),_info[1].substr(4,2),_info[2].substr(0,1),_info[2].substr(1,2),_info[2].substr(3,1),_info[2].substr(4,2),_info[3].substr(0,1),_info[3].substr(1,2),_info[3].substr(3,1),_info[3].substr(4,2),_info[4].substr(0,1),_info[4].substr(1,2),_info[4].substr(3,1),_info[4].substr(4,2),_info[5].substr(0,1),_info[5].substr(1,2),_info[5].substr(3,1),_info[5].substr(4,2)];return parseInt(_calday[n-1])},toChinaMonth:function(m){if(m>12||m<1)return-1;var s=calendar.nStr3[m-1];return s+="月"},toChinaDay:function(d){var s;switch(d){case 10:s="初十";break;case 20:s="二十";break;case 30:s="三十";break;default:s=calendar.nStr2[Math.floor(d/10)],s+=calendar.nStr1[d%10]}return s},getAnimal:function(y){return calendar.Animals[(y-4)%12]},solar2lunar:function(y,m,d){if(y<1900||y>2100)return-1;if(1900==y&&1==m&&d<31)return-1;if(y)var objDate=new Date(y,parseInt(m)-1,d);else var objDate=new Date;var i,leap=0,temp=0,y=objDate.getFullYear(),m=objDate.getMonth()+1,d=objDate.getDate(),offset=(Date.UTC(objDate.getFullYear(),objDate.getMonth(),objDate.getDate())-Date.UTC(1900,0,31))/864e5;for(i=1900;i<2101&&offset>0;i++)temp=calendar.lYearDays(i),offset-=temp;offset<0&&(offset+=temp,i--);var isTodayObj=new Date,isToday=!1;isTodayObj.getFullYear()==y&&isTodayObj.getMonth()+1==m&&isTodayObj.getDate()==d&&(isToday=!0);var nWeek=objDate.getDay(),cWeek=calendar.nStr1[nWeek];0==nWeek&&(nWeek=7);var year=i,leap=calendar.leapMonth(i),isLeap=!1;for(i=1;i<13&&offset>0;i++)leap>0&&i==leap+1&&0==isLeap?(--i,isLeap=!0,temp=calendar.leapDays(year)):temp=calendar.monthDays(year,i),1==isLeap&&i==leap+1&&(isLeap=!1),offset-=temp;0==offset&&leap>0&&i==leap+1&&(isLeap?isLeap=!1:(isLeap=!0,--i)),offset<0&&(offset+=temp,--i);var month=i,day=offset+1,sm=m-1,gzY=calendar.toGanZhiYear(year),firstNode=calendar.getTerm(year,2*m-1),secondNode=calendar.getTerm(year,2*m),gzM=calendar.toGanZhi(12*(y-1900)+m+11);d>=firstNode&&(gzM=calendar.toGanZhi(12*(y-1900)+m+12));var isTerm=!1,Term=null;firstNode==d&&(isTerm=!0,Term=calendar.solarTerm[2*m-2]),secondNode==d&&(isTerm=!0,Term=calendar.solarTerm[2*m-1]);var dayCyclical=Date.UTC(y,sm,1,0,0,0,0)/864e5+25567+10,gzD=calendar.toGanZhi(dayCyclical+d-1),astro=calendar.toAstro(m,d);return{lYear:year,lMonth:month,lDay:day,Animal:calendar.getAnimal(year),IMonthCn:(isLeap?"闰":"")+calendar.toChinaMonth(month),IDayCn:calendar.toChinaDay(day),cYear:y,cMonth:m,cDay:d,gzYear:gzY,gzMonth:gzM,gzDay:gzD,isToday:isToday,isLeap:isLeap,nWeek:nWeek,ncWeek:"星期"+cWeek,isTerm:isTerm,Term:Term,astro:astro}},lunar2solar:function(y,m,d,isLeapMonth){var isLeapMonth=!!isLeapMonth,leapMonth=calendar.leapMonth(y);calendar.leapDays(y);if(isLeapMonth&&leapMonth!=m)return-1;if(2100==y&&12==m&&d>1||1900==y&&1==m&&d<31)return-1;var day=calendar.monthDays(y,m),_day=day;if(isLeapMonth&&(_day=calendar.leapDays(y,m)),y<1900||y>2100||d>_day)return-1;for(var offset=0,i=1900;i<y;i++)offset+=calendar.lYearDays(i);for(var leap=0,isAdd=!1,i=1;i<m;i++)leap=calendar.leapMonth(y),isAdd||leap<=i&&leap>0&&(offset+=calendar.leapDays(y),isAdd=!0),offset+=calendar.monthDays(y,i);isLeapMonth&&(offset+=day);var stmap=Date.UTC(1900,1,30,0,0,0),calObj=new Date(864e5*(offset+d-31)+stmap),cY=calObj.getUTCFullYear(),cM=calObj.getUTCMonth()+1,cD=calObj.getUTCDate();return calendar.solar2lunar(cY,cM,cD)}},
    todayLunar = calendar.solar2lunar(today.getFullYear(), today.getMonth() + 1, today.getDate()),
    solar = {"1262620800":"小寒","1263916800":"大寒","1265212800":"立春","1266508800":"雨水","1267804800":"惊蛰","1269100800":"春分","1270396800":"清明","1271692800":"谷雨","1272988800":"立夏","1274371200":"小满","1275753600":"芒种","1277049600":"夏至","1278432000":"小暑","1279814400":"大暑","1281110400":"立秋","1282492800":"处暑","1283875200":"白露","1285171200":"秋分","1286467200":"寒露","1287763200":"霜降","1289059200":"立冬","1290355200":"小雪","1291651200":"大雪","1292947200":"冬至","1294243200":"小寒","1295452800":"大寒","1296748800":"立春","1298044800":"雨水","1299340800":"惊蛰","1300636800":"春分","1301932800":"清明","1303228800":"谷雨","1304611200":"立夏","1305907200":"小满","1307289600":"芒种","1308672000":"夏至","1309968000":"小暑","1311350400":"大暑","1312732800":"立秋","1314028800":"处暑","1315411200":"白露","1316707200":"秋分","1318003200":"寒露","1319385600":"霜降","1320681600":"立冬","1321977600":"小雪","1323187200":"大雪","1324483200":"冬至","1325779200":"小寒","1327075200":"大寒","1328284800":"立春","1329580800":"雨水","1330876800":"惊蛰","1332172800":"春分","1333468800":"清明","1334851200":"谷雨","1336147200":"立夏","1337443200":"小满","1338825600":"芒种","1340208000":"夏至","1341590400":"小暑","1342886400":"大暑","1344268800":"立秋","1345651200":"处暑","1346947200":"白露","1348243200":"秋分","1349625600":"寒露","1350921600":"霜降","1352217600":"立冬","1353513600":"小雪","1354809600":"大雪","1356019200":"冬至","1357315200":"小寒","1358611200":"大寒","1359907200":"立春","1361116800":"雨水","1362412800":"惊蛰","1363708800":"春分","1365004800":"清明","1366387200":"谷雨","1367683200":"立夏","1369065600":"小满","1370361600":"芒种","1371744000":"夏至","1373126400":"小暑","1374422400":"大暑","1375804800":"立秋","1377187200":"处暑","1378483200":"白露","1379865600":"秋分","1381161600":"寒露","1382457600":"霜降","1383753600":"立冬","1385049600":"小雪","1386345600":"大雪","1387641600":"冬至","1388851200":"小寒","1390147200":"大寒","1391443200":"立春","1392739200":"雨水","1394035200":"惊蛰","1395331200":"春分","1396627200":"清明","1397923200":"谷雨","1399219200":"立夏","1400601600":"小满","1401984000":"芒种","1403280000":"夏至","1404662400":"小暑","1406044800":"大暑","1407340800":"立秋","1408723200":"处暑","1410105600":"白露","1411401600":"秋分","1412697600":"寒露","1413993600":"霜降","1415289600":"立冬","1416585600":"小雪","1417881600":"大雪","1419177600":"冬至","1420473600":"小寒","1421683200":"大寒","1422979200":"立春","1424275200":"雨水","1425571200":"惊蛰","1426867200":"春分","1428163200":"清明","1429459200":"谷雨","1430841600":"立夏","1432137600":"小满","1433520000":"芒种","1434902400":"夏至","1436198400":"小暑","1437580800":"大暑","1438963200":"立秋","1440259200":"处暑","1441641600":"白露","1442937600":"秋分","1444233600":"寒露","1445616000":"霜降","1446912000":"立冬","1448121600":"小雪","1449417600":"大雪","1450713600":"冬至","1452009600":"小寒","1453219200":"大寒","1454515200":"立春","1455811200":"雨水","1457107200":"惊蛰","1458403200":"春分","1459699200":"清明","1460995200":"谷雨","1462377600":"立夏","1463673600":"小满","1465056000":"芒种","1466438400":"夏至","1467820800":"小暑","1469116800":"大暑","1470499200":"立秋","1471881600":"处暑","1473177600":"白露","1474473600":"秋分","1475856000":"寒露","1477152000":"霜降","1478448000":"立冬","1479744000":"小雪","1481040000":"大雪","1482249600":"冬至","1483545600":"小寒","1484841600":"大寒","1486051200":"立春","1487347200":"雨水","1488643200":"惊蛰","1489939200":"春分","1491235200":"清明","1492617600":"谷雨","1493913600":"立夏","1495296000":"小满","1496592000":"芒种","1497974400":"夏至","1499356800":"小暑","1500652800":"大暑","1502035200":"立秋","1503417600":"处暑","1504713600":"白露","1506096000":"秋分","1507392000":"寒露","1508688000":"霜降","1509984000":"立冬","1511280000":"小雪","1512576000":"大雪","1513872000":"冬至","1515081600":"小寒","1516377600":"大寒","1517673600":"立春","1518969600":"雨水","1520179200":"惊蛰","1521561600":"春分","1522857600":"清明","1524153600":"谷雨","1525449600":"立夏","1526832000":"小满","1528214400":"芒种","1529510400":"夏至","1530892800":"小暑","1532275200":"大暑","1533571200":"立秋","1534953600":"处暑","1536336000":"白露","1537632000":"秋分","1538928000":"寒露","1540224000":"霜降","1541520000":"立冬","1542816000":"小雪","1544112000":"大雪","1545408000":"冬至","1546617600":"小寒","1547913600":"大寒","1549209600":"立春","1550505600":"雨水","1551801600":"惊蛰","1553097600":"春分","1554393600":"清明","1555689600":"谷雨","1557072000":"立夏","1558368000":"小满","1559750400":"芒种","1561046400":"夏至","1562428800":"小暑","1563811200":"大暑","1565193600":"立秋","1566489600":"处暑","1567872000":"白露","1569168000":"秋分","1570464000":"寒露","1571846400":"霜降","1573142400":"立冬","1574352000":"小雪","1575648000":"大雪","1576944000":"冬至","1578240000":"小寒","1579449600":"大寒","1580745600":"立春","1582041600":"雨水","1583337600":"惊蛰","1584633600":"春分","1585929600":"清明","1587225600":"谷雨","1588608000":"立夏","1589904000":"小满","1591286400":"芒种","1592668800":"夏至","1593964800":"小暑","1595347200":"大暑","1596729600":"立秋","1598025600":"处暑","1599408000":"白露","1600704000":"秋分","1602086400":"寒露","1603382400":"霜降","1604678400":"立冬","1605974400":"小雪","1607270400":"大雪","1608480000":"冬至","1609776000":"小寒","1611072000":"大寒","1612281600":"立春","1613577600":"雨水","1614873600":"惊蛰","1616169600":"春分","1617465600":"清明","1618848000":"谷雨","1620144000":"立夏","1621526400":"小满","1622822400":"芒种","1624204800":"夏至","1625587200":"小暑","1626883200":"大暑","1628265600":"立秋","1629648000":"处暑","1630944000":"白露","1632326400":"秋分","1633622400":"寒露","1634918400":"霜降","1636214400":"立冬","1637510400":"小雪","1638806400":"大雪","1640016000":"冬至","1641312000":"小寒","1642608000":"大寒","1643904000":"立春","1645200000":"雨水","1646409600":"惊蛰","1647705600":"春分","1649088000":"清明","1650384000":"谷雨","1651680000":"立夏","1653062400":"小满","1654444800":"芒种","1655740800":"夏至","1657123200":"小暑","1658505600":"大暑","1659801600":"立秋","1661184000":"处暑","1662480000":"白露","1663862400":"秋分","1665158400":"寒露","1666454400":"霜降","1667750400":"立冬","1669046400":"小雪","1670342400":"大雪","1671638400":"冬至","1672848000":"小寒","1674144000":"大寒","1675440000":"立春","1676736000":"雨水","1678032000":"惊蛰","1679328000":"春分","1680624000":"清明","1681920000":"谷雨","1683302400":"立夏","1684598400":"小满","1685980800":"芒种","1687276800":"夏至","1688659200":"小暑","1690041600":"大暑","1691424000":"立秋","1692720000":"处暑","1694102400":"白露","1695398400":"秋分","1696694400":"寒露","1698076800":"霜降","1699372800":"立冬","1700582400":"小雪","1701878400":"大雪","1703174400":"冬至","1704470400":"小寒","1705680000":"大寒","1706976000":"立春","1708272000":"雨水","1709568000":"惊蛰","1710864000":"春分","1712160000":"清明","1713456000":"谷雨","1714838400":"立夏","1716134400":"小满","1717516800":"芒种","1718899200":"夏至","1720195200":"小暑","1721577600":"大暑","1722960000":"立秋","1724256000":"处暑","1725638400":"白露","1726934400":"秋分","1728316800":"寒露","1729612800":"霜降","1730908800":"立冬","1732204800":"小雪","1733414400":"大雪","1734710400":"冬至","1736006400":"小寒","1737302400":"大寒","1738512000":"立春","1739808000":"雨水","1741104000":"惊蛰","1742400000":"春分","1743696000":"清明","1745078400":"谷雨","1746374400":"立夏","1747756800":"小满","1749052800":"芒种","1750435200":"夏至","1751817600":"小暑","1753113600":"大暑","1754496000":"立秋","1755878400":"处暑","1757174400":"白露","1758556800":"秋分","1759852800":"寒露","1761148800":"霜降","1762444800":"立冬","1763740800":"小雪","1765036800":"大雪","1766246400":"冬至","1767542400":"小寒","1768838400":"大寒","1770134400":"立春","1771344000":"雨水","1772640000":"惊蛰","1773936000":"春分","1775318400":"清明","1776614400":"谷雨","1777910400":"立夏","1779292800":"小满","1780588800":"芒种","1781971200":"夏至","1783353600":"小暑","1784736000":"大暑","1786032000":"立秋","1787414400":"处暑","1788710400":"白露","1790092800":"秋分","1791388800":"寒露","1792684800":"霜降","1793980800":"立冬","1795276800":"小雪","1796572800":"大雪","1797868800":"冬至","1799078400":"小寒","1800374400":"大寒","1801670400":"立春","1802966400":"雨水","1804262400":"惊蛰","1805558400":"春分","1806854400":"清明","1808150400":"谷雨","1809532800":"立夏","1810828800":"小满","1812211200":"芒种","1813507200":"夏至","1814889600":"小暑","1816272000":"大暑","1817654400":"立秋","1818950400":"处暑","1820332800":"白露","1821628800":"秋分","1822924800":"寒露","1824220800":"霜降","1825516800":"立冬","1826812800":"小雪","1828108800":"大雪","1829404800":"冬至","1830700800":"小寒","1831910400":"大寒","1833206400":"立春","1834502400":"雨水","1835798400":"惊蛰","1837094400":"春分","1838390400":"清明","1839686400":"谷雨","1841068800":"立夏","1842364800":"小满","1843747200":"芒种","1845129600":"夏至","1846425600":"小暑","1847808000":"大暑","1849190400":"立秋","1850486400":"处暑","1851868800":"白露","1853164800":"秋分","1854547200":"寒露","1855843200":"霜降","1857139200":"立冬","1858435200":"小雪","1859644800":"大雪","1860940800":"冬至","1862236800":"小寒","1863532800":"大寒","1864742400":"立春","1866038400":"雨水","1867334400":"惊蛰","1868630400":"春分","1869926400":"清明","1871308800":"谷雨","1872604800":"立夏","1873987200":"小满","1875283200":"芒种","1876665600":"夏至","1878048000":"小暑","1879344000":"大暑","1880726400":"立秋","1882108800":"处暑","1883404800":"白露","1884787200":"秋分","1886083200":"寒露","1887379200":"霜降","1888675200":"立冬","1889971200":"小雪","1891267200":"大雪","1892476800":"冬至","1893772800":"小寒","1895068800":"大寒","1896364800":"立春","1897574400":"雨水","1898870400":"惊蛰","1900166400":"春分","1901548800":"清明","1902844800":"谷雨","1904140800":"立夏","1905523200":"小满","1906819200":"芒种","1908201600":"夏至","1909584000":"小暑","1910966400":"大暑","1912262400":"立秋","1913644800":"处暑","1914940800":"白露","1916323200":"秋分","1917619200":"寒露","1918915200":"霜降","1920211200":"立冬","1921507200":"小雪","1922803200":"大雪","1924099200":"冬至"},
    offset = (new Date().getTimezoneOffset()) * 60,
    holiday = {1483113600:1,1483200000:1,1483286400:1,1485014400:0,1485446400:1,1485532800:1,1485619200:1,1485705600:1,1485792000:1,1485878400:1,1485964800:1,1486137600:0,1490976000:0,1491062400:1,1491148800:1,1491235200:1,1493395200:1,1493481600:1,1493568000:1,1495814400:0,1495900800:1,1495987200:1,1496073600:1,1506700800:0,1506787200:1,1506873600:1,1506960000:1,1507046400:1,1507132800:1,1507219200:1,1507305600:1,1507392000:1};

let calendarEvent = [],
    initCalendar = function(){
        calendarDom.fullCalendar( 'destroy' );
        calendarDom.fullCalendar({
            timezone: 'local',
            firstDay: 1,
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            selectable: true,
            selectHelper: true,
            select: function(start, end, resource) {
                let events = '',
                    count = 1;
                calendarDom.fullCalendar('clientEvents', function(event) {
                    if(event.start >= start && event.end <= end) {
                        events += '<br>' + count + '. ' + event.title;
                        count++;
                    }
                });
                dialogs.prompt('History event:' + events, (title) => {
                    if (title) {
                        let eventData = {
                            title: title,
                            start: start,
                            end: end
                        };
                        calendarDom.fullCalendar('renderEvent', eventData, true); // stick? = true
                        calendarEvent.push(eventData);
                        storage.set('calendar', calendarEvent);
                        calendarEventObj.val(JSON.stringify(calendarEvent, null, 3));
                    }
                    calendarDom.fullCalendar('unselect');
                });
            },
            eventClick: function(calEvent, jsEvent, view){
                dialogs.alert(calEvent.title);
            },
            editable: true,
            eventLimit: true, // allow "more" link when too many events
            titleFormat: 'MMMM YYYY - ' +
                todayLunar.IMonthCn + ' ' +
                todayLunar.IDayCn + ' ' +
                todayLunar.Animal + '年 \r\n' +
                todayLunar.astro + ' ' +
                todayLunar.gzYear + '年 ' +
                todayLunar.gzMonth + '月 ' +
                todayLunar.gzDay + '日 ',
            events: calendarEvent,
            dayRender: function( date, cell ) {
                let key = (date.valueOf() / 1000 | 0) + offset,
                    holidayHtml = '',
                    newDate = new Date(key * 1000);
                if(holiday.hasOwnProperty(key)){
                    if(holiday[key] == 0){
                        cell.addClass("not-holiday");
                        holidayHtml += '<span class="not-holiday-span">班</span>';
                    }else{
                        cell.addClass("yes-holiday");
                        holidayHtml += '<span class="yes-holiday-span">休</span>';
                    }
                }
                cell.html(
                    '<span style="color:#aaa;font-size: 12px;">' +
                    calendar.solar2lunar(newDate.getFullYear(), newDate.getMonth() + 1, newDate.getDate()).IDayCn +
                    (solar.hasOwnProperty(key) ? ' - ' + solar[key] : '') +
                    '</span>' + holidayHtml
                );
            }
        });
    };

$(document).ready(function() {
    storage.get('calendar', (error, data) => {
        calendarEvent = Object.keys(data).length == 0 ? [] : data;
        calendarEventObj.text(JSON.stringify(calendarEvent, null, 3));
        initCalendar();
    });
});
$('#calendar-event-save').click(function(){
    let _val = calendarEventObj.val();
    try{
        let json = JSON.parse(_val);
        storage.set('calendar', json, () => {
            calendarEvent = json;
            initCalendar();
        });
    }catch(e){
        console.log(e);
        dialogs.alert('json格式有误');
    }
});

setInterval(function(){
    initCalendar();
}, 600000);